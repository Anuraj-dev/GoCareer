<%- include('partials/header', {
  title: 'Career Assessment Test', 
  customStyles: include('partials/test-styles')
}) %>

<%- include('partials/navigation', {
  path: '/assessment'
}) %>

<div class="container d-flex justify-content-center py-5">
  <div class="card glass-card">
    <div class="card-header text-light">
      <h4 class="mb-1">Career Path Assessment</h4>
      <small class="text-light opacity-75">Let's discover your educational journey</small>
    </div>
    <div class="card-body">
      <!-- Progress Bar -->
      <div class="progress-bar-custom mb-4">
        <div class="progress-step active" data-step="1">
          <div class="progress-step-label">Basic Info</div>
        </div>
        <div class="progress-step" data-step="2">
          <div class="progress-step-label">Education</div>
        </div>
        <div class="progress-step" data-step="3">
          <div class="progress-step-label">Career Path</div>
        </div>
      </div>

      <form id="careerForm" action="/test" method="POST" class="needs-validation" novalidate>
        <!-- Step 1: Basic Info -->
        <div class="step active" id="step1">
          <div class="form-group mb-4">
            <label for="qualification" class="form-label">Highest Qualification</label>
            <select name="qualification" id="qualification" class="form-select" required>
              <option value="">Select your qualification</option>
              <option value="after10th">Class 10</option>
              <option value="after12th">Class 12</option>
            </select>
            <div class="invalid-feedback">Please select your qualification.</div>
          </div>

          <div class="form-group mb-4">
            <label for="age" class="form-label">Age</label>
            <input type="number" name="age" id="age" class="form-control" min="14" max="25" placeholder="Enter your age" required>
            <div class="invalid-feedback">Please enter a valid age between 14 and 25.</div>
          </div>

          <div class="form-group mb-4">
            <label for="location" class="form-label">Location</label>
            <input type="text" name="location" id="location" class="form-control" placeholder="Enter your city/village" required>
            <div class="invalid-feedback">Please enter your location.</div>
          </div>
        </div>

        <!-- Step 2: Education -->
        <div class="step" id="step2" style="display: none;">
          <!-- After 10th Options -->
          <div id="after10thOptions" style="display: none;">
            <div class="form-group mb-4">
              <label class="form-label">What would you like to do after 10th?</label>
              <div class="form-check">
                <input type="radio" name="after10th" value="continue" class="form-check-input" id="continue10th">
                <label class="form-check-label" for="continue10th">Continue to 11th & 12th</label>
              </div>
              <div class="form-check">
                <input type="radio" name="after10th" value="diploma" class="form-check-input" id="diploma">
                <label class="form-check-label" for="diploma">Pursue Diploma</label>
              </div>
              <div class="form-check">
                <input type="radio" name="after10th" value="iti" class="form-check-input" id="iti">
                <label class="form-check-label" for="iti">Join ITI</label>
              </div>
            </div>
          </div>

          <!-- Stream Selection -->
          <div id="streamSelection" style="display: none;">
            <div class="form-group mb-4">
              <label class="form-label" id="streamLabel">Choose your stream</label>
              <div class="form-check">
                <input type="radio" name="stream" value="pcm" class="form-check-input" id="pcm">
                <label class="form-check-label" for="pcm">PCM (Physics, Chemistry, Mathematics)</label>
              </div>
              <div class="form-check">
                <input type="radio" name="stream" value="pcb" class="form-check-input" id="pcb">
                <label class="form-check-label" for="pcb">PCB (Physics, Chemistry, Biology)</label>
              </div>
              <div class="form-check">
                <input type="radio" name="stream" value="commerce" class="form-check-input" id="commerce">
                <label class="form-check-label" for="commerce">Commerce</label>
              </div>
              <div class="form-check">
                <input type="radio" name="stream" value="arts" class="form-check-input" id="arts">
                <label class="form-check-label" for="arts">Arts/Humanities</label>
              </div>
            </div>
          </div>

          <!-- Additional Subjects -->
          <div id="additionalSubjects" style="display: none;">
            <div class="form-group mb-4">
              <label for="additionalSubjectsInput" class="form-label">Additional Subjects</label>
              <input type="text" name="subjects" id="additionalSubjectsInput" class="form-control" placeholder="Enter any additional subjects you are interested in (comma separated)">
            </div>
          </div>

          <div id="higherStudiesContainer" style="display: none;">
            <div class="form-group mb-4">
              <label for="higherStudies" class="form-label">Are you planning to do higher studies?</label>
              <select name="higherStudies" id="higherStudies" class="form-select" required>
                <option value="">Please select</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Step 3: Career Path -->
        <div class="step" id="step3" style="display: none;">
          <div class="form-group mb-4">
            <label class="form-label">What are your interests? (Choose all that apply)</label>
            <div class="form-check">
              <input type="checkbox" name="interests" value="technology" class="form-check-input" id="tech">
              <label class="form-check-label" for="tech">Technology & Programming</label>
            </div>
            <div class="form-check">
              <input type="checkbox" name="interests" value="science" class="form-check-input" id="science">
              <label class="form-check-label" for="science">Science & Research</label>
            </div>
            <div class="form-check">
              <input type="checkbox" name="interests" value="business" class="form-check-input" id="business">
              <label class="form-check-label" for="business">Business & Entrepreneurship</label>
            </div>
            <div class="form-check">
              <input type="checkbox" name="interests" value="arts" class="form-check-input" id="arts">
              <label class="form-check-label" for="arts">Arts & Design</label>
            </div>
            <div class="form-check">
              <input type="checkbox" name="interests" value="healthcare" class="form-check-input" id="healthcare">
              <label class="form-check-label" for="healthcare">Healthcare & Medicine</label>
            </div>
          </div>
          
          <div class="form-group mb-4">
            <label for="incomeLevel" class="form-label">What is your family's monthly income? (Optional)</label>
            <select name="incomeLevel" id="incomeLevel" class="form-select">
              <option value="">Prefer not to say</option>
              <option value="low">Below ₹15,000</option>
              <option value="medium">₹15,000 - ₹50,000</option>
              <option value="high">Above ₹50,000</option>
            </select>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-4">
          <button type="button" class="btn btn-outline-secondary" id="prevBtn" style="display: none;">
            <i class="fas fa-arrow-left me-2"></i>
            Previous
          </button>
          <button type="button" class="btn btn-primary ms-auto" id="nextBtn">
            Continue
            <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
      </form>

      <!-- Results Container -->
      <div id="career-results-container" class="mt-5"></div>
    </div>
  </div>
</div>

<%- include('partials/loading-overlay') %>

<%- include('partials/footer', {
  useVanta: false,
  customScripts: `
    ${include('partials/test-scripts')}
    
    // Form validation
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation');
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
          .forEach(function(form) {
            form.addEventListener('submit', function(event) {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add('was-validated');
            }, false);
          });

        // Add form state management
        const formState = {
          currentStep: 1,
          qualification: '',
          after10th: '',
          higherStudies: '',
          shouldSkipCareerStep: false
        };

        // DOM Elements
        const qualificationSelect = document.getElementById('qualification');
        const after10thOptions = document.getElementById('after10thOptions');
        const streamSelection = document.getElementById('streamSelection');
        const additionalSubjects = document.getElementById('additionalSubjects');
        const higherStudiesContainer = document.getElementById('higherStudiesContainer');
        const higherStudiesSelect = document.getElementById('higherStudies');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const steps = document.querySelectorAll('.step');
        const progressSteps = document.querySelectorAll('.progress-step');
        
        // Reset form sections
        function resetEducationOptions() {
          // Hide all education options first
          after10thOptions.style.display = 'none';
          streamSelection.style.display = 'none';
          additionalSubjects.style.display = 'none';
          higherStudiesContainer.style.display = 'none';
          
          // Clear previous selections
          document.querySelectorAll('input[name="after10th"]').forEach(input => input.checked = false);
          document.querySelectorAll('input[name="stream"]').forEach(input => input.checked = false);
          document.getElementById('additionalSubjectsInput').value = '';
          higherStudiesSelect.value = '';
          
          // Update state
          formState.after10th = '';
          formState.higherStudies = '';
        }
        
        // Update education options based on qualification
        function updateEducationOptions() {
          resetEducationOptions();
          
          // Show relevant options based on qualification
          if (formState.qualification === 'after10th') {
            after10thOptions.style.display = 'block';
            higherStudiesContainer.style.display = 'block';
          } else if (formState.qualification === 'after12th') {
            streamSelection.style.display = 'block';
            additionalSubjects.style.display = 'block';
            higherStudiesContainer.style.display = 'block';
          }
        }
        
        // Handle qualification change
        qualificationSelect.addEventListener('change', function() {
          formState.qualification = this.value;
          updateEducationOptions();
        });
        
        // Handle higher studies change
        higherStudiesSelect.addEventListener('change', function() {
          formState.higherStudies = this.value;
          formState.shouldSkipCareerStep = (this.value === 'No');
        });
        
        // After10th options change
        document.querySelectorAll('input[name="after10th"]').forEach(input => {
          input.addEventListener('change', function() {
            formState.after10th = this.value;
            // Show stream selection only if continuing to 11th & 12th
            if (this.value === 'continue') {
              streamSelection.style.display = 'block';
              additionalSubjects.style.display = 'block';
            } else {
              streamSelection.style.display = 'none';
              additionalSubjects.style.display = 'none';
              // Clear stream selections
              document.querySelectorAll('input[name="stream"]').forEach(input => input.checked = false);
              document.getElementById('additionalSubjectsInput').value = '';
            }
          });
        });
        
        // Navigation: Show step
        function showStep(step) {
          // Hide all steps
          steps.forEach(s => s.style.display = 'none');
          // Show current step
          steps[step-1].style.display = 'block';
          // Update progress
          progressSteps.forEach((ps, i) => {
            if (i+1 < step) {
              ps.classList.add('active');
              ps.classList.add('completed');
            } else if (i+1 === step) {
              ps.classList.add('active');
              ps.classList.remove('completed');
            } else {
              ps.classList.remove('active');
              ps.classList.remove('completed');
            }
          });
          
          // Show/hide previous button
          prevBtn.style.display = step > 1 ? 'block' : 'none';
          
          // Update button text for final step
          if (step === 3) {
            nextBtn.innerHTML = 'Submit <i class="fas fa-paper-plane ms-2"></i>';
          } else {
            nextBtn.innerHTML = 'Continue <i class="fas fa-arrow-right ms-2"></i>';
          }
          
          formState.currentStep = step;
        }
        
        // Next button click
        nextBtn.addEventListener('click', function() {
          let currentStep = formState.currentStep;
          let form = document.getElementById('careerForm');
          
          // Validate current step
          let isValid = true;
          
          if (currentStep === 1) {
            // Validate step 1
            if (!qualificationSelect.value || !document.getElementById('age').value || !document.getElementById('location').value) {
              isValid = false;
              form.classList.add('was-validated');
            }
          } else if (currentStep === 2) {
            // Validate step 2
            if (formState.qualification === 'after10th' && !formState.after10th) {
              isValid = false;
              alert('Please select what you would like to do after 10th.');
            } else if (formState.qualification === 'after10th' && formState.after10th === 'continue' && 
                     !document.querySelector('input[name="stream"]:checked')) {
              isValid = false;
              alert('Please select a stream.');
            } else if (formState.qualification === 'after12th' && 
                     !document.querySelector('input[name="stream"]:checked')) {
              isValid = false;
              alert('Please select a stream.');
            } else if (!higherStudiesSelect.value) {
              isValid = false;
              alert('Please indicate if you plan to do higher studies.');
            }
          }
          
          if (isValid) {
            if (currentStep === 1) {
              showStep(2);
              updateEducationOptions();
            } else if (currentStep === 2) {
              // If user doesn't want higher studies, submit the form instead of showing step 3
              if (formState.shouldSkipCareerStep) {
                form.submit();
              } else {
                showStep(3);
              }
            } else if (currentStep === 3) {
              // Submit the form
              form.submit();
            }
          }
        });
        
        // Previous button click
        prevBtn.addEventListener('click', function() {
          let currentStep = formState.currentStep;
          
          if (currentStep > 1) {
            showStep(currentStep - 1);
            
            // If going back to step 1, reset education options to ensure they match the qualification
            if (currentStep - 1 === 1) {
              formState.qualification = qualificationSelect.value;
            }
          }
        });
      }, false);
    })();
  `,
  transparent: true
}) %>
